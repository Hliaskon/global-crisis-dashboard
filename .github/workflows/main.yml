name: Crisis Dashboard Automation

on:
  workflow_dispatch:
  schedule:
    - cron: '0 6 * * 1-5'   # Weekdays 06:00 UTC

permissions:
  contents: read
  pages: write
  id-token: write
  issues: write

concurrency:
  group: "pages"
  cancel-in-progress: true

jobs:
  build-and-render:
    runs-on: ubuntu-latest
    env:
      PYTHONPATH: ${{ github.workspace }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Print runner environment
        run: |
          set -euxo pipefail
          uname -a
          echo "SHELL=$SHELL"
          python --version
          ls -la

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies (requests, pandas, numpy, pyyaml)
        run: |
          set -euxo pipefail
          python -m pip install --upgrade pip
          pip install requests pandas numpy pyyaml

      - name: Download FRED data
        env:
          FRED_API_KEY: ${{ secrets.FRED_API_KEY }}
        run: |
          set -euxo pipefail
          python pipeline/update_fred_data.py
          echo "---- List data dir ----"
          ls -l data || true
          echo "---- Preview CSVs ----"
          for f in data/*.csv; do echo "FILE: $f"; head -n 5 "$f" || true; done

      - name: Download ECB EXR data (FX) and derive USD/X
        run: |
          set -euxo pipefail
          python pipeline/update_ecb_data.py
          echo "---- Show USD/EUR & USD/JPY 5 lines ----"
          head -n 5 data/eur_usd_ecb.csv || true
          head -n 5 data/usd_jpy_ecb.csv || true

      # OECD CLI pulls (amplitude-adjusted, monthly)
      - name: Download OECD CLI - China
        run: |
          set -euxo pipefail
          python pipeline/update_oecd_cli.py CHN china_cli_oecd.csv
          head -n 5 data/china_cli_oecd.csv || true

      - name: Download OECD CLI - Japan
        run: |
          set -euxo pipefail
          python pipeline/update_oecd_cli.py JPN japan_cli_oecd.csv
          head -n 5 data/japan_cli_oecd.csv || true

      - name: Download OECD CLI - Germany
        run: |
          set -euxo pipefail
          python pipeline/update_oecd_cli.py DEU germany_cli_oecd.csv
          head -n 5 data/germany_cli_oecd.csv || true

      - name: Download OECD CLI - France
        run: |
          set -euxo pipefail
          python pipeline/update_oecd_cli.py FRA france_cli_oecd.csv
          head -n 5 data/france_cli_oecd.csv || true

      - name: Download OECD CLI - Italy
        run: |
          set -euxo pipefail
          python pipeline/update_oecd_cli.py ITA italy_cli_oecd.csv
          head -n 5 data/italy_cli_oecd.csv || true

      - name: Download OECD CLI - UK
        run: |
          set -euxo pipefail
          python pipeline/update_oecd_cli.py GBR uk_cli_oecd.csv
          head -n 5 data/uk_cli_oecd.csv || true

      - name: Download OECD CLI - Canada
        run: |
          set -euxo pipefail
          python pipeline/update_oecd_cli.py CAN canada_cli_oecd.csv
          head -n 5 data/canada_cli_oecd.csv || true

      - name: Download OECD CLI - India
        run: |
          set -euxo pipefail
          python pipeline/update_oecd_cli.py IND india_cli_oecd.csv
          head -n 5 data/india_cli_oecd.csv || true

      - name: Download OECD CLI - Russia
        run: |
          set -euxo pipefail
          python pipeline/update_oecd_cli.py RUS russia_cli_oecd.csv
          head -n 5 data/russia_cli_oecd.csv || true

          
      - name: Download US IG OAS (FRED)
        run: |
          set -euxo pipefail
          python pipeline/update_ig_oas_fred.py
          echo "---- Preview IG OAS (head) ----"
          head -n 5 data/ig_oas.csv || true

          
      - name: Download US 10y Breakevens (FRED T10YIE)
        run: |
          set -euxo pipefail
          python pipeline/update_breakevens_fred.py
          echo "---- Preview T10YIE (head) ----"
          head -n 5 data/t10yie.csv || true


      - name: Download Baltic Dry Index (Stooq)
        run: |
          set -euxo pipefail
          python pipeline/update_bdi_stooq.py
          echo "---- Preview BDI (head) ----"
          head -n 5 data/bdi_stooq.csv || true

          
      - name: Download Gold & Copper (Stooq)
        run: |
          set -euxo pipefail
          python pipeline/update_imf_commodities.py
          echo "---- Preview Gold (head) ----"
          head -n 5 data/gold_imf.csv || true
          echo "---- Preview Copper (head) ----"
          head -n 5 data/copper_imf.csv || true


      # === Country equity indices (Stooq) ===
      - name: Download Equity Index - Japan
        run: |
          set -euxo pipefail
          python pipeline/update_equity_index_stooq.py --symbols "^n225,^nkx" --out eq_japan.csv
          head -n 5 data/eq_japan.csv || true
      
      - name: Download Equity Index - Germany
        run: |
          set -euxo pipefail
          python pipeline/update_equity_index_stooq.py --symbols "^dax,dax" --out eq_germany.csv
          head -n 5 data/eq_germany.csv || true
      
      - name: Download Equity Index - France
        run: |
          set -euxo pipefail
          python pipeline/update_equity_index_stooq.py --symbols "^cac,cac40,^px1" --out eq_france.csv
          head -n 5 data/eq_france.csv || true
      
      - name: Download Equity Index - Italy
        run: |
          set -euxo pipefail
          python pipeline/update_equity_index_stooq.py --symbols "^ftsemib,^mib" --out eq_italy.csv
          head -n 5 data/eq_italy.csv || true
      
      - name: Download Equity Index - United Kingdom
        run: |
          set -euxo pipefail
          python pipeline/update_equity_index_stooq.py --symbols "^ftse,ftse" --out eq_united_kingdom.csv
          head -n 5 data/eq_united_kingdom.csv || true
      
      - name: Download Equity Index - Canada
        run: |
          set -euxo pipefail
          python pipeline/update_equity_index_stooq.py --symbols "^tsx,tsx" --out eq_canada.csv
          head -n 5 data/eq_canada.csv || true
      
      - name: Download Equity Index - India
        run: |
          set -euxo pipefail
          python pipeline/update_equity_index_stooq.py --symbols "^nifty,^nse50" --out eq_india.csv
          head -n 5 data/eq_india.csv || true
      
      - name: Download Equity Index - Russia
        run: |
          set -euxo pipefail
          python pipeline/update_equity_index_stooq.py --symbols "^imoex,imoex" --out eq_russia.csv
          head -n 5 data/eq_russia.csv || true
        
      - name: Download Brent (FRED)
        run: |
          set -euxo pipefail
          python pipeline/update_brent_fred.py
          head -n 5 data/brent_spot_fred.csv || true
      
      - name: Download S&P 500 (FRED)
        run: |
          set -euxo pipefail
          python pipeline/update_sp500_fred.py
          head -n 5 data/sp500_fred.csv || true
      
      # Gold (choose one path):
      # If licensed LBMA:
      # - name: Download Gold (LBMA licensed)
      #   run: python pipeline/update_gold_lbma.py
      #   # head -n 5 data/gold_lbma_usd.csv
      # Else: disable until you select a source
      
      - name: Download BIS policy rates
        run: |
          set -euxo pipefail
          python pipeline/update_policy_rate_bis.py US policy_us.csv
          python pipeline/update_policy_rate_bis.py DE policy_de.csv
          python pipeline/update_policy_rate_bis.py FR policy_fr.csv
          python pipeline/update_policy_rate_bis.py IT policy_it.csv
          python pipeline/update_policy_rate_bis.py GB policy_gb.csv
          python pipeline/update_policy_rate_bis.py CA policy_ca.csv
          python pipeline/update_policy_rate_bis.py JP policy_jp.csv
          python pipeline/update_policy_rate_bis.py IN policy_in.csv
          python pipeline/update_policy_rate_bis.py RU policy_ru.csv
      
      - name: Download OECD 10Y yields
        run: |
          set -euxo pipefail
          python pipeline/update_oecd_yields.py US yield10_us.csv
          python pipeline/update_oecd_yields.py DE yield10_de.csv
          python pipeline/update_oecd_yields.py FR yield10_fr.csv
          python pipeline/update_oecd_yields.py IT yield10_it.csv
          python pipeline/update_oecd_yields.py GB yield10_gb.csv
          python pipeline/update_oecd_yields.py JP yield10_jp.csv
          python pipeline/update_oecd_yields.py CA yield10_ca.csv
      
      - name: Download OECD Industrial Production
        run: |
          set -euxo pipefail
          python pipeline/update_oecd_ip.py DE ip_de.csv
          python pipeline/update_oecd_ip.py FR ip_fr.csv
          python pipeline/update_oecd_ip.py IT ip_it.csv
          python pipeline/update_oecd_ip.py US ip_us.csv
          python pipeline/update_oecd_ip.py JP ip_jp.csv
      
      # Optional:
      # - name: Download BIS Debt Service Ratio (households)
      #   run: |
      #     python pipeline/update_bis_dsr.py DE dsr_hh_de.csv
      #     ...      

      
      # --- NEW: fetch last run's opportunities.json from GitHub Pages ---
      - name: Fetch previous opportunities.json (if exists on Pages)
        run: |
          set -euxo pipefail
          mkdir -p output
          BASE="https://${GITHUB_REPOSITORY%%/*}.github.io/${GITHUB_REPOSITORY#*/}/opportunities.json"
          if curl -fsSL "$BASE" -o output/prev_opportunities.json ; then
            echo "---- prev_opportunities.json (head) ----"
            head -n 30 output/prev_opportunities.json || true
          else
            echo "No previous opportunities.json found."
          fi

      - name: Generate dashboard HTML
        run: |
          set -euxo pipefail
          python pipeline/compute_dashboard.py
          echo "---- List output dir ----"
          ls -l output || true
          echo "---- Preview top of index.html ----"
          head -n 40 output/index.html || true

      - name: Upload data artifact
        uses: actions/upload-artifact@v4
        with:
          name: collected-data
          path: data/*.csv
          if-no-files-found: ignore

      - name: Upload dashboard HTML
        uses: actions/upload-artifact@v4
        with:
          name: dashboard-html
          path: output/index.html
          if-no-files-found: error

      - name: Upload dashboard state JSON
        uses: actions/upload-artifact@v4
        with:
          name: dashboard-state
          path: output/state.json
          if-no-files-found: error

      - name: Create/Update ALERT issue (if triggered)
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs'); // Only fs. 'core' and 'github' are injected by github-script.

            function readJSON(p){ try { return JSON.parse(fs.readFileSync(p,'utf8')); } catch(e){ return null; } }
            const cur  = readJSON('output/state.json');
            const prev = readJSON('output/prev_state.json');
            if (!cur) { core.info('state.json not found; skipping alert issue.'); return; }

            const alerting = [];
            if (cur.composite_level === 'ALERT') alerting.push('Global Composite');
            if (Array.isArray(cur.countries)) {
              for (const c of cur.countries) {
                if (c.level === 'ALERT') alerting.push(`${c.name} Subscore`);
              }
            }
            if (alerting.length === 0) { core.info('No ALERT levels; skipping issue.'); return; }

            const repoFull = process.env.GITHUB_REPOSITORY || '';
            const parts = repoFull.split('/');
            if (parts.length < 2) { core.warning('GITHUB_REPOSITORY invalid; skipping issue.'); return; }
            const owner = parts[0], repo = parts[1];

            // Ensure 'alert' label exists
            try { await github.rest.issues.getLabel({ owner, repo, name: 'alert' }); }
            catch (e) {
              try {
                await github.rest.issues.createLabel({
                  owner, repo, name: 'alert', color: 'D93F0B',
                  description: 'Auto-created label for Crisis Dashboard ALERTs'
                });
                core.info('Created label: alert');
              } catch (e2) { core.warning('Could not create label "alert": ' + String(e2)); }
            }

            const generated = cur.generated_utc || '-';
            const compVal   = (cur.composite ?? '-');
            const compLvl   = cur.composite_level || '-';

            // Top 3 Movers vs previous
            const curC  = cur.contributions || {};
            const prevC = (prev && prev.contributions) ? prev.contributions : {};
            const deltas = Object.keys(curC).map(k => ({ label: k, delta: curC[k] - (prevC[k] || 0) }));
            deltas.sort((a,b) => Math.abs(b.delta) - Math.abs(a.delta));
            const top3 = deltas.slice(0,3);

            const dashboardUrl = `https://${owner}.github.io/${repo}/`;
            const lines = [
              `**Generated (UTC):** ${generated}`,
              ``,
              `**Global Composite:** ${compVal} â€” **Level:** ${compLvl}`,
              ``,
              `**Top Movers vs Previous:**`,
              ...top3.map(t => `â€¢ ${t.label}: ${t.delta >= 0 ? '+' : ''}${t.delta.toFixed(2)}`),
              ``,
              `Dashboard: ${dashboardUrl}`
            ];
            const title = `ðŸš¨ Crisis Dashboard ALERT: ${alerting.join(' & ')} (${generated})`;
            const body  = lines.join('\n');

            // Reuse single open issue with label 'alert'
            const { data: issues } = await github.rest.issues.listForRepo({ owner, repo, state: 'open', labels: 'alert' });
            if (issues.length > 0) {
              const issue = issues[0];
              await github.rest.issues.update({ owner, repo, issue_number: issue.number, title, body });
              core.info(`Updated existing alert issue #${issue.number}`);
            } else {
              const { data: issue } = await github.rest.issues.create({ owner, repo, title, body, labels: ['alert'] });
              core.info(`Created alert issue #${issue.number}`);
            }

      - name: Upload Pages artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: output

  deploy:
    needs: build-and-render
    runs-on: ubuntu-latest
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    steps:
      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4

